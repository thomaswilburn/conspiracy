<!doctype html>

<template id="clock">
  <style>
:host {
  display: inline-block;
}

.time {
  display: flex;
  align-items: center;
  font-family: system-ui;
  font-variant-numeric: tabular-nums;
  gap: 16px;
}

.big {
  font-size: 400%;
}

.suffix {
  font-weight: bold;
}

.faded {
  opacity: 30%;
}
  </style>
  <div class="time">
    <div class="big" on:click="toggleMilitary">
      <embed text:=formattedTime.hours>:<embed text:=formattedTime.minutes>:<embed text:=formattedTime.seconds>
    </div>
    <div class="suffix">
      <span class:faded="formattedTime.pm">AM</span>
      <hr>
      <span class:faded.not="formattedTime.pm">PM</span>
    </div>
  </div>
</template>

<template id="multiple">
  <style>
.clocks {
  text-align: center;
  font-family: system-ui;
}

.here {
  & h1 {
    font-weight: bold;
    margin: 0;
  }
}

.there {
  display: flex;
  justify-content: space-around;
  font-size: 60%;
  border-top: 2px dashed black;
  margin-top: 20px;
  padding-top: 20px;

  h2 {
    margin: 0;
    font-size: 200%;
  }
}
  </style>
  <div class="clocks">
    <div class="here">
      <h1>Chicago</h1>
      <clock-face></clock-face>
    </div>
    <div ref:there class="there">
      <div class="location" each:="clocks">
        <h2><!-- text:label --></h2>
        <clock-face attr:offset="offset" prop:offsetValue="offset"></clock-face>
      </div>
    </div>
  </div>
</template>

<div id="host"></div>

<script type="module">

import { Conspiracy } from "./index.js";

class ConspiracyElement extends HTMLElement {
  constructor() {
    super();
    var Class = new.target;
    if (Class.template) {
      this.attachShadow({ mode: "open" });
      this.ui = Class.template.renderTo(this.shadowRoot);
      queueMicrotask(() => this.render());
    }
    this.render = this.render.bind(this);
  }

  render() {
    this.ui.update(this);
  }
}

class ClockFace extends ConspiracyElement {
  static template = new Conspiracy(window.clock);

  constructor() {
    super();
    this.toggleMilitary = this.toggleMilitary.bind(this);
    this.use24Hours = false;
  }

  connectedCallback() {
    this.disconnectedCallback();
    this.interval = setInterval(this.render, 1000);
    this.render();
  }

  disconnectedCallback() {
    if (this.interval) {
      clearInterval(this.interval);
      this.interval = null;
    }
  }

  render() {
    this.ui.update(this);
  }

  get formattedTime() {
    var offset = (this.getAttribute("offset") || 0) * 60 * 60 * 1000;
    var now = Date.now()
    var time = new Date(now + offset);
    var hours = time.getHours();
    var pm = hours > 11;
    if (!this.use24Hours) {
      if (hours == 0) hours = 12;
      if (hours > 12) {
        hours -= 12;
      }
    }
    return {
      hours: String(hours).padStart(2, "0"),
      minutes: String(time.getMinutes()).padStart(2, "0"),
      seconds: String(time.getSeconds()).padStart(2, "0"),
      pm
    }
  }

  toggleMilitary() {
    this.use24Hours = !this.use24Hours;
    this.render();
  }
}

customElements.define("clock-face", ClockFace);

var clocks = [
  { label: "Washington", offset: +1 },
  { label: "Seattle", offset: -2 },
  { label: "Barcelona", offset: +7 }
];
var app = new Conspiracy(multiple).renderTo(host, { clocks });

</script>